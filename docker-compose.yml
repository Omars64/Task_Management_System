services:
  # SQL Server Database
  database:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: workhub-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'if /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$MSSQL_SA_PASSWORD\" -C -Q \"SELECT 1\" -b -o /dev/null 2>&1; then exit 0; else exit 1; fi'"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 90s
    networks:
      - workhub-network

  # Backend API
  backend:
    build:
      context: ./workhub-backend
      dockerfile: Dockerfile
    container_name: workhub-backend
    environment:
      - DB_DIALECT=mssql
      - DB_HOST=database
      - DB_PORT=1433
      - DB_NAME=workhub
      - DB_USER=sa
      - DB_PASSWORD=${SA_PASSWORD}
      - DB_DRIVER=ODBC Driver 18 for SQL Server
      - DB_ODBC_PARAMS=Encrypt=no;TrustServerCertificate=yes
      - SECRET_KEY=production-secret-key-change-me
      - JWT_SECRET_KEY=production-jwt-secret-key
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USE_TLS=True
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_DEFAULT_SENDER=${MAIL_DEFAULT_SENDER}
      - EMAIL_NOTIFICATIONS_ENABLED=${EMAIL_NOTIFICATIONS_ENABLED}
      - FRONTEND_URL=http://localhost:3000
    ports:
      - "5000:5000"
    depends_on:
      database:
        condition: service_healthy
    networks:
      - workhub-network
    volumes:
      - ./workhub-backend/uploads:/app/uploads

  # Frontend
  frontend:
    build:
      context: ./workhub-frontend
      dockerfile: Dockerfile
    container_name: workhub-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - workhub-network

volumes:
  mssql_data:

networks:
  workhub-network:
    driver: bridge
